"use strict";(()=>{var e={};e.id=179,e.ids=[179],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},6675:(e,t,a)=>{a.r(t),a.d(t,{config:()=>d,default:()=>c,routeModule:()=>p});var i={};a.r(i),a.d(i,{default:()=>u});var r=a(1802),n=a(7153),s=a(6249),o=a(9102);async function l(e){if(!e.lapTimesLog||0===e.lapTimesLog.length)return;let t=new Map((await o.Z.circuit.findMany()).map(e=>[e.name,e])),a=new Map,i=new Map;for(let[r,n]of(e.lapTimesLog.forEach(e=>{a.has(e.circuitName)||(a.set(e.circuitName,[]),i.set(e.circuitName,[])),a.get(e.circuitName).push(e.time)}),e.circuitResults.forEach((t,a)=>{let r=e.circuits[a]?.name;r&&t.turns.forEach(e=>{e.forEach(e=>{e.averageTime&&e.averageTime>0&&(i.has(r)||i.set(r,[]),i.get(r).push(e.averageTime))})})}),a)){let a=t.get(r);if(!a||0===n.length)continue;let s=Math.min(...n),l=i.get(r)||[],u=l.length>0?Math.min(...l):null,c=!1,d={};if(!a.historicalBestLap||s<a.historicalBestLap){d.historicalBestLap=s,d.historicalBestLapDate=new Date;let t=e.lapTimesLog.find(e=>e.circuitName===r&&e.time===s);t&&(d.bestLapHolderId=t.playerId),c=!0}if(u&&(!a.historicalBestAverage||u<a.historicalBestAverage)){d.historicalBestAverage=u,d.historicalBestAverageDate=new Date;let t=null;for(let a of e.circuitResults){let e=a.turns.flat().find(e=>e.averageTime===u);if(e){t=e;break}}t&&(d.bestAverageHolderId=t.playerId),c=!0}c&&await o.Z.circuit.update({where:{id:a.id},data:d})}}async function u(e,t){if("PUT"===e.method)try{let{id:a,state:i,status:r}=e.body;if(!a)return t.status(400).json({error:"Game ID is required."});i&&await l(i);let n=await o.Z.game.update({where:{id:a},data:{state:i||void 0,status:r||void 0}});t.status(200).json(n)}catch(e){console.error("Game update error:",e),t.status(500).json({error:"Failed to update game"})}else t.setHeader("Allow",["PUT"]),t.status(405).end(`Method ${e.method} Not Allowed`)}let c=(0,s.l)(i,"default"),d=(0,s.l)(i,"config"),p=new r.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/game/update",pathname:"/api/game/update",bundlePath:"",filename:""},userland:i})},9102:(e,t,a)=>{a.d(t,{Z:()=>r});let i=require("@prisma/client"),r=globalThis.prisma||new i.PrismaClient},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=6675);module.exports=a})();